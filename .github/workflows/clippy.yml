name: Clippy

on:
  push:
    branches: [ main, devel ]
    paths-ignore: [ "**.md", "docs/**" ]
  pull_request:
    branches: [ main, devel ]
    paths-ignore: [ "**.md", "docs/**" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  clippy:
    name: Clippy (${{ matrix.name }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: root workspace
            manifest: ./Cargo.toml
          - name: contracts workspace
            manifest: ./contracts/Cargo.toml
          - name: examples workspace
            manifest: ./examples/Cargo.toml

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install system deps (clang/libclang)
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libclang-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Ensure clippy component is installed
        run: rustup component add clippy

      - name: Install wasm32 target
        run: rustup target list --installed | grep -q '^wasm32-unknown-unknown$' || rustup target add wasm32-unknown-unknown

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          shared-key: clippy-${{ matrix.manifest }}

      - name: Prefetch deps
        run: cargo fetch --locked

      - name: Run clippy
        run: |
          cargo clippy --manifest-path="${{ matrix.manifest }}" --workspace --all-targets --all-features -- -D warnings \
            -A clippy::uninit_vec \
            -A clippy::manual_div_ceil \
            -A clippy::manual_saturating_arithmetic \
            -A clippy::needless_borrows_for_generic_args \
            -A clippy::needless_borrow \
            -A clippy::needless_as_bytes \
            -A clippy::if_same_then_else \
            -A clippy::clone_on_copy \
            -A clippy::identity_op \
            -A clippy::arc_with_non_send_sync \
            -A clippy::large_enum_variant \
            -A clippy::unnecessary_literal_unwrap \
            -A clippy::let_and_return \
            -A clippy::suspicious_doc_comments \
            -A clippy::let_unit_value \
            -A clippy::explicit_auto_deref \
            -A clippy::useless_conversion \
            -A clippy::result_unit_err \
            -A clippy::vec_init_then_push \
            -A clippy::int_plus_one \
            -A clippy::unit_arg \
            -A clippy::type_complexity \
            -A clippy::single_match \
            -A clippy::empty_docs \
            -A clippy::extra_unused_type_parameters \
            -A clippy::match_single_binding \
            -A clippy::len_zero \
            -A clippy::slow_vector_initialization \
            -A clippy::single_element_loop \
            -A clippy::unnecessary_mut_passed \
            -A clippy::single_component_path_imports \
            -A clippy::bool_assert_comparison \
            -A clippy::unit_cmp \
            -A clippy::field_reassign_with_default
