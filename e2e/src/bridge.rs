use core::str::from_utf8;
use fluentbase_sdk::{address, bytes, calc_create_address, Address, Bytes, U256};
use fluentbase_sdk_testing::{EvmTestingContext, HostTestingContextNativeAPI, TxBuilder};
use hex_literal::hex;
use revm::context::result::{ExecutionResult, Output};

#[test]
fn test_bridge_contract() {
    // deploy greeting EVM contract
    let mut ctx = EvmTestingContext::default();
    const SENDER_ADDRESS: Address = address!("d9b36c6c8bfcc633bb83372db44d80f352cdfe3f");
    ctx.add_balance(SENDER_ADDRESS, U256::from(2e18));
    // now send success tx
    let contract_address = calc_create_address::<HostTestingContextNativeAPI>(&SENDER_ADDRESS, 0);
    let mut tx_builder = TxBuilder::create(
        &mut ctx,
        SENDER_ADDRESS,
        hex!("60806040523480156200001157600080fd5b506040805160208082018352600080835283519182019093529182529060036200003c8382620000f9565b5060046200004b8282620000f9565b505050620001c5565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200007f57607f821691505b602082108103620000a057634e487b7160e01b600052602260045260246000fd5b50919050565b601f821115620000f457600081815260208120601f850160051c81016020861015620000cf5750805b601f850160051c820191505b81811015620000f057828155600101620000db565b5050505b505050565b81516001600160401b0381111562000115576200011562000054565b6200012d816200012684546200006a565b84620000a6565b602080601f8311600181146200016557600084156200014c5750858301515b600019600386901b1c1916600185901b178555620000f0565b600085815260208120601f198616915b82811015620001965788860151825594840194600190910190840162000175565b5085821015620001b55787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b610bab80620001d56000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c806370a082311161008c578063a9059cbb11610066578063a9059cbb146101a2578063c820f146146101b5578063dd62ed3e146101c8578063df1f29ee1461020157600080fd5b806370a082311461015e57806395d89b41146101875780639dc29fac1461018f57600080fd5b806306fdde03146100d4578063095ea7b3146100f257806318160ddd1461011557806323b872dd14610127578063313ce5671461013a57806340c10f1914610149575b600080fd5b6100dc610227565b6040516100e991906107a6565b60405180910390f35b610105610100366004610810565b6102b9565b60405190151581526020016100e9565b6002545b6040519081526020016100e9565b61010561013536600461083a565b6102d3565b604051601281526020016100e9565b61015c610157366004610810565b6102f7565b005b61011961016c366004610876565b6001600160a01b031660009081526020819052604090205490565b6100dc610351565b61015c61019d366004610810565b610360565b6101056101b0366004610810565b6103b1565b61015c6101c336600461093b565b6103bf565b6101196101d63660046109d9565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b600954600854604080516001600160a01b039384168152929091166020830152016100e9565b60606006805461023690610a0c565b80601f016020809104026020016040519081016040528092919081815260200182805461026290610a0c565b80156102af5780601f10610284576101008083540402835291602001916102af565b820191906000526020600020905b81548152906001019060200180831161029257829003601f168201915b5050505050905090565b6000336102c781858561044c565b60019150505b92915050565b6000336102e185828561045e565b6102ec8585856104dc565b506001949350505050565b6007546001600160a01b031633146103435760405162461bcd60e51b815260206004820152600a60248201526937b7363c9037bbb732b960b11b60448201526064015b60405180910390fd5b61034d828261053b565b5050565b60606005805461023690610a0c565b6007546001600160a01b031633146103a75760405162461bcd60e51b815260206004820152600a60248201526937b7363c9037bbb732b960b11b604482015260640161033a565b61034d8282610571565b6000336102c78185856104dc565b6007546001600160a01b0316156103d557600080fd5b600780546001600160a01b0319163317905560056103f38582610a94565b5060066104008682610a94565b50600880546001600160a01b039283166001600160a01b03199091161790556009805460ff909416600160a01b026001600160a81b031990941692909116919091179190911790555050565b61045983838360016105a7565b505050565b6001600160a01b0383811660009081526001602090815260408083209386168352929052205460001981146104d657818110156104c757604051637dc7a0d960e11b81526001600160a01b0384166004820152602481018290526044810183905260640161033a565b6104d6848484840360006105a7565b50505050565b6001600160a01b03831661050657604051634b637e8f60e11b81526000600482015260240161033a565b6001600160a01b0382166105305760405163ec442f0560e01b81526000600482015260240161033a565b61045983838361067c565b6001600160a01b0382166105655760405163ec442f0560e01b81526000600482015260240161033a565b61034d6000838361067c565b6001600160a01b03821661059b57604051634b637e8f60e11b81526000600482015260240161033a565b61034d8260008361067c565b6001600160a01b0384166105d15760405163e602df0560e01b81526000600482015260240161033a565b6001600160a01b0383166105fb57604051634a1406b160e11b81526000600482015260240161033a565b6001600160a01b03808516600090815260016020908152604080832093871683529290522082905580156104d657826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161066e91815260200190565b60405180910390a350505050565b6001600160a01b0383166106a757806002600082825461069c9190610b54565b909155506107199050565b6001600160a01b038316600090815260208190526040902054818110156106fa5760405163391434e360e21b81526001600160a01b0385166004820152602481018290526044810183905260640161033a565b6001600160a01b03841660009081526020819052604090209082900390555b6001600160a01b03821661073557600280548290039055610754565b6001600160a01b03821660009081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161079991815260200190565b60405180910390a3505050565b600060208083528351808285015260005b818110156107d3578581018301518582016040015282016107b7565b506000604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b038116811461080b57600080fd5b919050565b6000806040838503121561082357600080fd5b61082c836107f4565b946020939093013593505050565b60008060006060848603121561084f57600080fd5b610858846107f4565b9250610866602085016107f4565b9150604084013590509250925092565b60006020828403121561088857600080fd5b610891826107f4565b9392505050565b634e487b7160e01b600052604160045260246000fd5b600082601f8301126108bf57600080fd5b813567ffffffffffffffff808211156108da576108da610898565b604051601f8301601f19908116603f0116810190828211818310171561090257610902610898565b8160405283815286602085880101111561091b57600080fd5b836020870160208301376000602085830101528094505050505092915050565b600080600080600060a0868803121561095357600080fd5b853567ffffffffffffffff8082111561096b57600080fd5b61097789838a016108ae565b9650602088013591508082111561098d57600080fd5b5061099a888289016108ae565b945050604086013560ff811681146109b157600080fd5b92506109bf606087016107f4565b91506109cd608087016107f4565b90509295509295909350565b600080604083850312156109ec57600080fd5b6109f5836107f4565b9150610a03602084016107f4565b90509250929050565b600181811c90821680610a2057607f821691505b602082108103610a4057634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561045957600081815260208120601f850160051c81016020861015610a6d5750805b601f850160051c820191505b81811015610a8c57828155600101610a79565b505050505050565b815167ffffffffffffffff811115610aae57610aae610898565b610ac281610abc8454610a0c565b84610a46565b602080601f831160018114610af75760008415610adf5750858301515b600019600386901b1c1916600185901b178555610a8c565b600085815260208120601f198616915b82811015610b2657888601518255948401946001909101908401610b07565b5085821015610b445787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b808201808211156102cd57634e487b7160e01b600052601160045260246000fdfea264697066735822122020392651e573f9944e7a325289c46a3be569262ab593d01ed253c5598ffd5a9464736f6c63430008140033").into())
        .gas_price(0);
    assert!(!tx_builder
        .ctx
        .db
        .cache
        .accounts
        .contains_key(&contract_address));
    let exec_result = tx_builder.exec();
    assert!(tx_builder
        .ctx
        .db
        .cache
        .accounts
        .contains_key(&contract_address));
    let contract_account = tx_builder
        .ctx
        .db
        .cache
        .accounts
        .get(&contract_address)
        .unwrap();
    assert_eq!(contract_account.info.nonce, 1);
    assert!(contract_account.info.code.is_some());
    assert!(!contract_account.info.code_hash.is_zero());
    assert!(exec_result.is_success());
}

#[test]
fn test_bridge_contract2() {
    let mut ctx = EvmTestingContext::default();
    const SENDER_ADDRESS: Address = address!("f39Fd6e51aad88F6F4ce6aB8827279cffFb92266");
    let result = TxBuilder::create(
        &mut ctx,
        SENDER_ADDRESS,
        hex!("60806040523480156200001157600080fd5b5060405180602001604052806000815250604051806020016040528060008152508160039081620000439190620002d8565b508060049081620000559190620002d8565b505050620003bf565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620000e057607f821691505b602082108103620000f657620000f562000098565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620001607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000121565b6200016c868362000121565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b6000620001b9620001b3620001ad8462000184565b6200018e565b62000184565b9050919050565b6000819050919050565b620001d58362000198565b620001ed620001e482620001c0565b8484546200012e565b825550505050565b600090565b62000204620001f5565b62000211818484620001ca565b505050565b5b8181101562000239576200022d600082620001fa565b60018101905062000217565b5050565b601f82111562000288576200025281620000fc565b6200025d8462000111565b810160208510156200026d578190505b620002856200027c8562000111565b83018262000216565b50505b505050565b600082821c905092915050565b6000620002ad600019846008026200028d565b1980831691505092915050565b6000620002c883836200029a565b9150826002028217905092915050565b620002e3826200005e565b67ffffffffffffffff811115620002ff57620002fe62000069565b5b6200030b8254620000c7565b620003188282856200023d565b600060209050601f8311600181146200035057600084156200033b578287015190505b620003478582620002ba565b865550620003b7565b601f1984166200036086620000fc565b60005b828110156200038a5784890151825560018201915060208501945060208101905062000363565b86831015620003aa5784890151620003a6601f8916826200029a565b8355505b6001600288020188555050505b505050505050565b610e5580620003cf6000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063313ce56711610066578063313ce5671461013457806370a082311461015257806395d89b4114610182578063a9059cbb146101a0578063dd62ed3e146101d057610093565b806306fdde0314610098578063095ea7b3146100b657806318160ddd146100e657806323b872dd14610104575b600080fd5b6100a0610200565b6040516100ad9190610aa9565b60405180910390f35b6100d060048036038101906100cb9190610b64565b610292565b6040516100dd9190610bbf565b60405180910390f35b6100ee6102b5565b6040516100fb9190610be9565b60405180910390f35b61011e60048036038101906101199190610c04565b6102bf565b60405161012b9190610bbf565b60405180910390f35b61013c6102ee565b6040516101499190610c73565b60405180910390f35b61016c60048036038101906101679190610c8e565b6102f7565b6040516101799190610be9565b60405180910390f35b61018a61033f565b6040516101979190610aa9565b60405180910390f35b6101ba60048036038101906101b59190610b64565b6103d1565b6040516101c79190610bbf565b60405180910390f35b6101ea60048036038101906101e59190610cbb565b6103f4565b6040516101f79190610be9565b60405180910390f35b60606003805461020f90610d2a565b80601f016020809104026020016040519081016040528092919081815260200182805461023b90610d2a565b80156102885780601f1061025d57610100808354040283529160200191610288565b820191906000526020600020905b81548152906001019060200180831161026b57829003601f168201915b5050505050905090565b60008061029d61047b565b90506102aa818585610483565b600191505092915050565b6000600254905090565b6000806102ca61047b565b90506102d7858285610495565b6102e2858585610529565b60019150509392505050565b60006012905090565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461034e90610d2a565b80601f016020809104026020016040519081016040528092919081815260200182805461037a90610d2a565b80156103c75780601f1061039c576101008083540402835291602001916103c7565b820191906000526020600020905b8154815290600101906020018083116103aa57829003601f168201915b5050505050905090565b6000806103dc61047b565b90506103e9818585610529565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b610490838383600161061d565b505050565b60006104a184846103f4565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146105235781811015610513578281836040517ffb8f41b200000000000000000000000000000000000000000000000000000000815260040161050a93929190610d6a565b60405180910390fd5b6105228484848403600061061d565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361059b5760006040517f96c6fd1e0000000000000000000000000000000000000000000000000000000081526004016105929190610da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361060d5760006040517fec442f050000000000000000000000000000000000000000000000000000000081526004016106049190610da1565b60405180910390fd5b6106188383836107f4565b505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff160361068f5760006040517fe602df050000000000000000000000000000000000000000000000000000000081526004016106869190610da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036107015760006040517f94280d620000000000000000000000000000000000000000000000000000000081526004016106f89190610da1565b60405180910390fd5b81600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555080156107ee578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516107e59190610be9565b60405180910390a35b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361084657806002600082825461083a9190610deb565b92505081905550610919565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050818110156108d2578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016108c993929190610d6a565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361096257806002600082825403925050819055506109af565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610a0c9190610be9565b60405180910390a3505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610a53578082015181840152602081019050610a38565b60008484015250505050565b6000601f19601f8301169050919050565b6000610a7b82610a19565b610a858185610a24565b9350610a95818560208601610a35565b610a9e81610a5f565b840191505092915050565b60006020820190508181036000830152610ac38184610a70565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610afb82610ad0565b9050919050565b610b0b81610af0565b8114610b1657600080fd5b50565b600081359050610b2881610b02565b92915050565b6000819050919050565b610b4181610b2e565b8114610b4c57600080fd5b50565b600081359050610b5e81610b38565b92915050565b60008060408385031215610b7b57610b7a610acb565b5b6000610b8985828601610b19565b9250506020610b9a85828601610b4f565b9150509250929050565b60008115159050919050565b610bb981610ba4565b82525050565b6000602082019050610bd46000830184610bb0565b92915050565b610be381610b2e565b82525050565b6000602082019050610bfe6000830184610bda565b92915050565b600080600060608486031215610c1d57610c1c610acb565b5b6000610c2b86828701610b19565b9350506020610c3c86828701610b19565b9250506040610c4d86828701610b4f565b9150509250925092565b600060ff82169050919050565b610c6d81610c57565b82525050565b6000602082019050610c886000830184610c64565b92915050565b600060208284031215610ca457610ca3610acb565b5b6000610cb284828501610b19565b91505092915050565b60008060408385031215610cd257610cd1610acb565b5b6000610ce085828601610b19565b9250506020610cf185828601610b19565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610d4257607f821691505b602082108103610d5557610d54610cfb565b5b50919050565b610d6481610af0565b82525050565b6000606082019050610d7f6000830186610d5b565b610d8c6020830185610bda565b610d996040830184610bda565b949350505050565b6000602082019050610db66000830184610d5b565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610df682610b2e565b9150610e0183610b2e565b9250828201905080821115610e1957610e18610dbc565b5b9291505056fea26469706673582212203f94478400ca0031ba543400a90ffc7349bed715f562669d8edd4af9ff89dcd664736f6c63430008140033").into()
    ).gas_limit(0x989680)
        .exec();
    assert!(result.is_success());
}

#[test]
fn test_bridge_contract_with_call() {
    // {
    //     "cd596583": "bridgeContract()",
    //     "aab858dd": "computePeggedTokenAddress(address)",
    //     "8da5cb5b": "owner()",
    //     "715018a6": "renounceOwnership()",
    //     "e77772fe": "tokenFactory()",
    //     "f2fde38b": "transferOwnership(address)"
    // }
    let mut ctx = EvmTestingContext::default();
    let signer_l1_wallet_owner = address!("f39Fd6e51aad88F6F4ce6aB8827279cffFb92266");
    let pegged_token_contract_address = address!("5FbDB2315678afecb367f032d93F642f64180aa3");
    let erc20token_contract_address = address!("e7f1725e7734ce288f8367e1bb143e90bb3f0512");
    let erc20gateway_contract_address = address!("9fe46736679d2d9a65f0992f2272de9f3c7fa6e0");
    let l1token_contract_address = address!("Dc64a140Aa3E981100a9becA4E685f962f0cF6C9");

    ctx.add_balance(signer_l1_wallet_owner, U256::from(1_000000000000000000u128));

    println!("\n\npegged_token_contract:");
    let mut pegged_token_factory_tx_builder = TxBuilder::create(
        &mut ctx,
        signer_l1_wallet_owner,
        hex!("60806040523480156200001157600080fd5b5060405180602001604052806000815250604051806020016040528060008152508160039081620000439190620002d8565b508060049081620000559190620002d8565b505050620003bf565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620000e057607f821691505b602082108103620000f657620000f562000098565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620001607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000121565b6200016c868362000121565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b6000620001b9620001b3620001ad8462000184565b6200018e565b62000184565b9050919050565b6000819050919050565b620001d58362000198565b620001ed620001e482620001c0565b8484546200012e565b825550505050565b600090565b62000204620001f5565b62000211818484620001ca565b505050565b5b8181101562000239576200022d600082620001fa565b60018101905062000217565b5050565b601f82111562000288576200025281620000fc565b6200025d8462000111565b810160208510156200026d578190505b620002856200027c8562000111565b83018262000216565b50505b505050565b600082821c905092915050565b6000620002ad600019846008026200028d565b1980831691505092915050565b6000620002c883836200029a565b9150826002028217905092915050565b620002e3826200005e565b67ffffffffffffffff811115620002ff57620002fe62000069565b5b6200030b8254620000c7565b620003188282856200023d565b600060209050601f8311600181146200035057600084156200033b578287015190505b620003478582620002ba565b865550620003b7565b601f1984166200036086620000fc565b60005b828110156200038a5784890151825560018201915060208501945060208101905062000363565b86831015620003aa5784890151620003a6601f8916826200029a565b8355505b6001600288020188555050505b505050505050565b610e5580620003cf6000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063313ce56711610066578063313ce5671461013457806370a082311461015257806395d89b4114610182578063a9059cbb146101a0578063dd62ed3e146101d057610093565b806306fdde0314610098578063095ea7b3146100b657806318160ddd146100e657806323b872dd14610104575b600080fd5b6100a0610200565b6040516100ad9190610aa9565b60405180910390f35b6100d060048036038101906100cb9190610b64565b610292565b6040516100dd9190610bbf565b60405180910390f35b6100ee6102b5565b6040516100fb9190610be9565b60405180910390f35b61011e60048036038101906101199190610c04565b6102bf565b60405161012b9190610bbf565b60405180910390f35b61013c6102ee565b6040516101499190610c73565b60405180910390f35b61016c60048036038101906101679190610c8e565b6102f7565b6040516101799190610be9565b60405180910390f35b61018a61033f565b6040516101979190610aa9565b60405180910390f35b6101ba60048036038101906101b59190610b64565b6103d1565b6040516101c79190610bbf565b60405180910390f35b6101ea60048036038101906101e59190610cbb565b6103f4565b6040516101f79190610be9565b60405180910390f35b60606003805461020f90610d2a565b80601f016020809104026020016040519081016040528092919081815260200182805461023b90610d2a565b80156102885780601f1061025d57610100808354040283529160200191610288565b820191906000526020600020905b81548152906001019060200180831161026b57829003601f168201915b5050505050905090565b60008061029d61047b565b90506102aa818585610483565b600191505092915050565b6000600254905090565b6000806102ca61047b565b90506102d7858285610495565b6102e2858585610529565b60019150509392505050565b60006012905090565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461034e90610d2a565b80601f016020809104026020016040519081016040528092919081815260200182805461037a90610d2a565b80156103c75780601f1061039c576101008083540402835291602001916103c7565b820191906000526020600020905b8154815290600101906020018083116103aa57829003601f168201915b5050505050905090565b6000806103dc61047b565b90506103e9818585610529565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b610490838383600161061d565b505050565b60006104a184846103f4565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146105235781811015610513578281836040517ffb8f41b200000000000000000000000000000000000000000000000000000000815260040161050a93929190610d6a565b60405180910390fd5b6105228484848403600061061d565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361059b5760006040517f96c6fd1e0000000000000000000000000000000000000000000000000000000081526004016105929190610da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361060d5760006040517fec442f050000000000000000000000000000000000000000000000000000000081526004016106049190610da1565b60405180910390fd5b6106188383836107f4565b505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff160361068f5760006040517fe602df050000000000000000000000000000000000000000000000000000000081526004016106869190610da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036107015760006040517f94280d620000000000000000000000000000000000000000000000000000000081526004016106f89190610da1565b60405180910390fd5b81600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555080156107ee578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516107e59190610be9565b60405180910390a35b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361084657806002600082825461083a9190610deb565b92505081905550610919565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050818110156108d2578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016108c993929190610d6a565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361096257806002600082825403925050819055506109af565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610a0c9190610be9565b60405180910390a3505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610a53578082015181840152602081019050610a38565b60008484015250505050565b6000601f19601f8301169050919050565b6000610a7b82610a19565b610a858185610a24565b9350610a95818560208601610a35565b610a9e81610a5f565b840191505092915050565b60006020820190508181036000830152610ac38184610a70565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610afb82610ad0565b9050919050565b610b0b81610af0565b8114610b1657600080fd5b50565b600081359050610b2881610b02565b92915050565b6000819050919050565b610b4181610b2e565b8114610b4c57600080fd5b50565b600081359050610b5e81610b38565b92915050565b60008060408385031215610b7b57610b7a610acb565b5b6000610b8985828601610b19565b9250506020610b9a85828601610b4f565b9150509250929050565b60008115159050919050565b610bb981610ba4565b82525050565b6000602082019050610bd46000830184610bb0565b92915050565b610be381610b2e565b82525050565b6000602082019050610bfe6000830184610bda565b92915050565b600080600060608486031215610c1d57610c1c610acb565b5b6000610c2b86828701610b19565b9350506020610c3c86828701610b19565b9250506040610c4d86828701610b4f565b9150509250925092565b600060ff82169050919050565b610c6d81610c57565b82525050565b6000602082019050610c886000830184610c64565b92915050565b600060208284031215610ca457610ca3610acb565b5b6000610cb284828501610b19565b91505092915050565b60008060408385031215610cd257610cd1610acb565b5b6000610ce085828601610b19565b9250506020610cf185828601610b19565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610d4257607f821691505b602082108103610d5557610d54610cfb565b5b50919050565b610d6481610af0565b82525050565b6000606082019050610d7f6000830186610d5b565b610d8c6020830185610bda565b610d996040830184610bda565b949350505050565b6000602082019050610db66000830184610d5b565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610df682610b2e565b9150610e0183610b2e565b9250828201905080821115610e1957610e18610dbc565b5b9291505056fea26469706673582212203f94478400ca0031ba543400a90ffc7349bed715f562669d8edd4af9ff89dcd664736f6c63430008140033").into());
    assert_eq!(
        signer_l1_wallet_owner,
        pegged_token_factory_tx_builder.tx.caller,
    );
    let result = pegged_token_factory_tx_builder.exec();
    match result {
        ExecutionResult::Success { output, .. } => match output {
            Output::Create(_, address) => {
                assert_eq!(pegged_token_contract_address, address.unwrap());
            }
            _ => panic!("expected 'create'"),
        },
        _ => panic!("expected 'success'"),
    }

    println!("\n\nerc20token_contract:");
    let mut erc20token_factory_tx_builder = TxBuilder::create(
        &mut ctx,
        signer_l1_wallet_owner,
        hex!("60806040523480156200001157600080fd5b5060405162000bc738038062000bc78339818101604052810190620000379190620002a7565b33600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620000ad5760006040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401620000a49190620002ea565b60405180910390fd5b620000be816200017960201b60201c565b50600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160362000131576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620001289062000368565b60405180910390fd5b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550506200038a565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200026f8262000242565b9050919050565b620002818162000262565b81146200028d57600080fd5b50565b600081519050620002a18162000276565b92915050565b600060208284031215620002c057620002bf6200023d565b5b6000620002d08482850162000290565b91505092915050565b620002e48162000262565b82525050565b6000602082019050620003016000830184620002d9565b92915050565b600082825260208201905092915050565b7f7a65726f20696d706c656d656e746174696f6e20616464726573730000000000600082015250565b600062000350601b8362000307565b91506200035d8262000318565b602082019050919050565b60006020820190508181036000830152620003838162000341565b9050919050565b61082d806200039a6000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c80638da5cb5b1161005b5780638da5cb5b146100da578063cd6f2760146100f8578063f2228ebc14610128578063f2fde38b146101585761007d565b80635c60da1b14610082578063715018a6146100a05780637ef2afdd146100aa575b600080fd5b61008a610174565b6040516100979190610663565b60405180910390f35b6100a861019a565b005b6100c460048036038101906100bf91906106af565b6101ae565b6040516100d19190610663565b60405180910390f35b6100e26101d3565b6040516100ef9190610663565b60405180910390f35b610112600480360381019061010d9190610716565b6101fc565b60405161011f9190610663565b60405180910390f35b610142600480360381019061013d9190610716565b610240565b60405161014f9190610663565b60405180910390f35b610172600480360381019061016d9190610756565b6102ed565b005b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6101a2610373565b6101ac60006103fa565b565b6000806101bb86866104be565b90506101c88482856104f1565b915050949350505050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008061020984846104be565b9050610237600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1682610552565b91505092915050565b600061024a610373565b600061025684846104be565b90506000610286600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1683610567565b90508073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167ff9a44e6db3fb6e0eb31c4013bda8c662fecef1768dd2412270cc8f8821cbccf360405160405180910390a3809250505092915050565b6102f5610373565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036103675760006040517f1e4fbdf700000000000000000000000000000000000000000000000000000000815260040161035e9190610663565b60405180910390fd5b610370816103fa565b50565b61037b61061a565b73ffffffffffffffffffffffffffffffffffffffff166103996101d3565b73ffffffffffffffffffffffffffffffffffffffff16146103f8576103bc61061a565b6040517f118cdaa70000000000000000000000000000000000000000000000000000000081526004016103ef9190610663565b60405180910390fd5b565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600082826040516020016104d39291906107cb565b60405160208183030381529060405280519060200120905092915050565b60006040518260388201526f5af43d82803e903d91602b57fd5bf3ff6024820152846014820152733d602d80600a3d3981f3363d3d373d3d3d363d7381528360588201526037600c8201206078820152605560438201209150509392505050565b600061055f8383306104f1565b905092915050565b6000763d602d80600a3d3981f3363d3d373d3d3d363d730000008360601b60e81c176000526e5af43d82803e903d91602b57fd5bf38360781b1760205281603760096000f59050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610614576040517fc2f868f400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b92915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061064d82610622565b9050919050565b61065d81610642565b82525050565b60006020820190506106786000830184610654565b92915050565b600080fd5b61068c81610642565b811461069757600080fd5b50565b6000813590506106a981610683565b92915050565b600080600080608085870312156106c9576106c861067e565b5b60006106d78782880161069a565b94505060206106e88782880161069a565b93505060406106f98782880161069a565b925050606061070a8782880161069a565b91505092959194509250565b6000806040838503121561072d5761072c61067e565b5b600061073b8582860161069a565b925050602061074c8582860161069a565b9150509250929050565b60006020828403121561076c5761076b61067e565b5b600061077a8482850161069a565b91505092915050565b60008160601b9050919050565b600061079b82610783565b9050919050565b60006107ad82610790565b9050919050565b6107c56107c082610642565b6107a2565b82525050565b60006107d782856107b4565b6014820191506107e782846107b4565b601482019150819050939250505056fea2646970667358221220ef5b73c53ef571e3032bcd524e89f7cb228f279419486d398ccd722a0eff091064736f6c634300081400330000000000000000000000005fbdb2315678afecb367f032d93f642f64180aa3").into());
    assert_eq!(
        signer_l1_wallet_owner,
        erc20token_factory_tx_builder.tx.caller,
    );
    let result = erc20token_factory_tx_builder.exec();
    match result {
        ExecutionResult::Success { output, .. } => match output {
            Output::Create(_, address) => {
                assert_eq!(erc20token_contract_address, address.unwrap());
            }
            _ => panic!("expected 'create'"),
        },
        _ => panic!("expected 'success'"),
    }

    println!("\n\nerc20gateway_contract:");
    let mut erc20gateway_factory_tx_builder = TxBuilder::create(
        &mut ctx,
        signer_l1_wallet_owner,
        hex!("608060405260405161084c38038061084c83398181016040528101906100259190610258565b33600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036100985760006040517f1e4fbdf700000000000000000000000000000000000000000000000000000000815260040161008f91906102a7565b60405180910390fd5b6100a78161013160201b60201c565b5081600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050506102c2565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610225826101fa565b9050919050565b6102358161021a565b811461024057600080fd5b50565b6000815190506102528161022c565b92915050565b6000806040838503121561026f5761026e6101f5565b5b600061027d85828601610243565b925050602061028e85828601610243565b9150509250929050565b6102a18161021a565b82525050565b60006020820190506102bc6000830184610298565b92915050565b61057b806102d16000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c8063715018a6146100675780638da5cb5b14610071578063aab858dd1461008f578063cd596583146100bf578063e77772fe146100dd578063f2fde38b146100fb575b600080fd5b61006f610117565b005b61007961012b565b6040516100869190610461565b60405180910390f35b6100a960048036038101906100a491906104ad565b610154565b6040516100b69190610461565b60405180910390f35b6100c76101fb565b6040516100d49190610461565b60405180910390f35b6100e5610221565b6040516100f29190610461565b60405180910390f35b610115600480360381019061011091906104ad565b610247565b005b61011f6102cd565b6101296000610354565b565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663cd6f276030846040518363ffffffff1660e01b81526004016101b39291906104da565b602060405180830381865afa1580156101d0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101f49190610518565b9050919050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b61024f6102cd565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036102c15760006040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016102b89190610461565b60405180910390fd5b6102ca81610354565b50565b6102d5610418565b73ffffffffffffffffffffffffffffffffffffffff166102f361012b565b73ffffffffffffffffffffffffffffffffffffffff161461035257610316610418565b6040517f118cdaa70000000000000000000000000000000000000000000000000000000081526004016103499190610461565b60405180910390fd5b565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061044b82610420565b9050919050565b61045b81610440565b82525050565b60006020820190506104766000830184610452565b92915050565b600080fd5b61048a81610440565b811461049557600080fd5b50565b6000813590506104a781610481565b92915050565b6000602082840312156104c3576104c261047c565b5b60006104d184828501610498565b91505092915050565b60006040820190506104ef6000830185610452565b6104fc6020830184610452565b9392505050565b60008151905061051281610481565b92915050565b60006020828403121561052e5761052d61047c565b5b600061053c84828501610503565b9150509291505056fea2646970667358221220519e506cbbf37fc9099e29fbd5f09d982167f702dc6160b48912d5cfa1f294ab64736f6c634300081400330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e7f1725e7734ce288f8367e1bb143e90bb3f0512").into())
        .value(U256::from(1000e9));
    assert_eq!(
        signer_l1_wallet_owner,
        erc20gateway_factory_tx_builder.tx.caller,
    );
    let result = erc20gateway_factory_tx_builder.exec();
    match result {
        ExecutionResult::Success { output, .. } => match output {
            Output::Create(_, address) => {
                assert_eq!(erc20gateway_contract_address, address.unwrap());
            }
            _ => panic!("expected 'create'"),
        },
        _ => panic!("expected 'success'"),
    }

    println!("\n\ntransferOwnership call:");
    let mut transfer_ownership_tx_builder = TxBuilder::call(
        &mut ctx,
        signer_l1_wallet_owner,
        erc20gateway_contract_address,
        None,
    )
    .input(bytes!(
        "\
        f2fde38b\
        0000000000000000000000009fe46736679d2d9a65f0992f2272de9f3c7fa6e0\
        "
    ));
    assert_eq!(
        signer_l1_wallet_owner,
        transfer_ownership_tx_builder.tx.caller,
    );
    let result = transfer_ownership_tx_builder.exec();
    match result {
        ExecutionResult::Success { output, .. } => match output {
            Output::Call(bytes) => {
                assert_eq!(Bytes::new(), bytes);
            }
            _ => panic!("expected 'call'"),
        },
        _ => panic!("expected 'success'"),
    }

    println!("\n\nl1token_contract:");
    let mut l1token_factory_tx_builder = TxBuilder::create(
        &mut ctx,
        signer_l1_wallet_owner,
        hex!("60806040523480156200001157600080fd5b50604051620018ab380380620018ab83398181016040528101906200003791906200056b565b838381600390816200004a91906200085c565b5080600490816200005c91906200085c565b5050506200007181836200007b60201b60201c565b5050505062000a46565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603620000f05760006040517fec442f05000000000000000000000000000000000000000000000000000000008152600401620000e7919062000954565b60405180910390fd5b62000104600083836200010860201b60201c565b5050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036200015e578060026000828254620001519190620009a0565b9250508190555062000234565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015620001ed578381836040517fe450d38c000000000000000000000000000000000000000000000000000000008152600401620001e493929190620009ec565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036200027f5780600260008282540392505081905550620002cc565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516200032b919062000a29565b60405180910390a3505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620003a18262000356565b810181811067ffffffffffffffff82111715620003c357620003c262000367565b5b80604052505050565b6000620003d862000338565b9050620003e6828262000396565b919050565b600067ffffffffffffffff82111562000409576200040862000367565b5b620004148262000356565b9050602081019050919050565b60005b838110156200044157808201518184015260208101905062000424565b60008484015250505050565b6000620004646200045e84620003eb565b620003cc565b90508281526020810184848401111562000483576200048262000351565b5b6200049084828562000421565b509392505050565b600082601f830112620004b057620004af6200034c565b5b8151620004c28482602086016200044d565b91505092915050565b6000819050919050565b620004e081620004cb565b8114620004ec57600080fd5b50565b6000815190506200050081620004d5565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620005338262000506565b9050919050565b620005458162000526565b81146200055157600080fd5b50565b60008151905062000565816200053a565b92915050565b6000806000806080858703121562000588576200058762000342565b5b600085015167ffffffffffffffff811115620005a957620005a862000347565b5b620005b78782880162000498565b945050602085015167ffffffffffffffff811115620005db57620005da62000347565b5b620005e98782880162000498565b9350506040620005fc87828801620004ef565b92505060606200060f8782880162000554565b91505092959194509250565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200066e57607f821691505b60208210810362000684576200068362000626565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620006ee7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620006af565b620006fa8683620006af565b95508019841693508086168417925050509392505050565b6000819050919050565b60006200073d620007376200073184620004cb565b62000712565b620004cb565b9050919050565b6000819050919050565b62000759836200071c565b62000771620007688262000744565b848454620006bc565b825550505050565b600090565b6200078862000779565b620007958184846200074e565b505050565b5b81811015620007bd57620007b16000826200077e565b6001810190506200079b565b5050565b601f8211156200080c57620007d6816200068a565b620007e1846200069f565b81016020851015620007f1578190505b6200080962000800856200069f565b8301826200079a565b50505b505050565b600082821c905092915050565b6000620008316000198460080262000811565b1980831691505092915050565b60006200084c83836200081e565b9150826002028217905092915050565b62000867826200061b565b67ffffffffffffffff81111562000883576200088262000367565b5b6200088f825462000655565b6200089c828285620007c1565b600060209050601f831160018114620008d45760008415620008bf578287015190505b620008cb85826200083e565b8655506200093b565b601f198416620008e4866200068a565b60005b828110156200090e57848901518255600182019150602085019450602081019050620008e7565b868310156200092e57848901516200092a601f8916826200081e565b8355505b6001600288020188555050505b505050505050565b6200094e8162000526565b82525050565b60006020820190506200096b600083018462000943565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000620009ad82620004cb565b9150620009ba83620004cb565b9250828201905080821115620009d557620009d462000971565b5b92915050565b620009e681620004cb565b82525050565b600060608201905062000a03600083018662000943565b62000a126020830185620009db565b62000a216040830184620009db565b949350505050565b600060208201905062000a406000830184620009db565b92915050565b610e558062000a566000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063313ce56711610066578063313ce5671461013457806370a082311461015257806395d89b4114610182578063a9059cbb146101a0578063dd62ed3e146101d057610093565b806306fdde0314610098578063095ea7b3146100b657806318160ddd146100e657806323b872dd14610104575b600080fd5b6100a0610200565b6040516100ad9190610aa9565b60405180910390f35b6100d060048036038101906100cb9190610b64565b610292565b6040516100dd9190610bbf565b60405180910390f35b6100ee6102b5565b6040516100fb9190610be9565b60405180910390f35b61011e60048036038101906101199190610c04565b6102bf565b60405161012b9190610bbf565b60405180910390f35b61013c6102ee565b6040516101499190610c73565b60405180910390f35b61016c60048036038101906101679190610c8e565b6102f7565b6040516101799190610be9565b60405180910390f35b61018a61033f565b6040516101979190610aa9565b60405180910390f35b6101ba60048036038101906101b59190610b64565b6103d1565b6040516101c79190610bbf565b60405180910390f35b6101ea60048036038101906101e59190610cbb565b6103f4565b6040516101f79190610be9565b60405180910390f35b60606003805461020f90610d2a565b80601f016020809104026020016040519081016040528092919081815260200182805461023b90610d2a565b80156102885780601f1061025d57610100808354040283529160200191610288565b820191906000526020600020905b81548152906001019060200180831161026b57829003601f168201915b5050505050905090565b60008061029d61047b565b90506102aa818585610483565b600191505092915050565b6000600254905090565b6000806102ca61047b565b90506102d7858285610495565b6102e2858585610529565b60019150509392505050565b60006012905090565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461034e90610d2a565b80601f016020809104026020016040519081016040528092919081815260200182805461037a90610d2a565b80156103c75780601f1061039c576101008083540402835291602001916103c7565b820191906000526020600020905b8154815290600101906020018083116103aa57829003601f168201915b5050505050905090565b6000806103dc61047b565b90506103e9818585610529565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b610490838383600161061d565b505050565b60006104a184846103f4565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146105235781811015610513578281836040517ffb8f41b200000000000000000000000000000000000000000000000000000000815260040161050a93929190610d6a565b60405180910390fd5b6105228484848403600061061d565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361059b5760006040517f96c6fd1e0000000000000000000000000000000000000000000000000000000081526004016105929190610da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361060d5760006040517fec442f050000000000000000000000000000000000000000000000000000000081526004016106049190610da1565b60405180910390fd5b6106188383836107f4565b505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff160361068f5760006040517fe602df050000000000000000000000000000000000000000000000000000000081526004016106869190610da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036107015760006040517f94280d620000000000000000000000000000000000000000000000000000000081526004016106f89190610da1565b60405180910390fd5b81600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555080156107ee578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516107e59190610be9565b60405180910390a35b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361084657806002600082825461083a9190610deb565b92505081905550610919565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050818110156108d2578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016108c993929190610d6a565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361096257806002600082825403925050819055506109af565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610a0c9190610be9565b60405180910390a3505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610a53578082015181840152602081019050610a38565b60008484015250505050565b6000601f19601f8301169050919050565b6000610a7b82610a19565b610a858185610a24565b9350610a95818560208601610a35565b610a9e81610a5f565b840191505092915050565b60006020820190508181036000830152610ac38184610a70565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610afb82610ad0565b9050919050565b610b0b81610af0565b8114610b1657600080fd5b50565b600081359050610b2881610b02565b92915050565b6000819050919050565b610b4181610b2e565b8114610b4c57600080fd5b50565b600081359050610b5e81610b38565b92915050565b60008060408385031215610b7b57610b7a610acb565b5b6000610b8985828601610b19565b9250506020610b9a85828601610b4f565b9150509250929050565b60008115159050919050565b610bb981610ba4565b82525050565b6000602082019050610bd46000830184610bb0565b92915050565b610be381610b2e565b82525050565b6000602082019050610bfe6000830184610bda565b92915050565b600080600060608486031215610c1d57610c1c610acb565b5b6000610c2b86828701610b19565b9350506020610c3c86828701610b19565b9250506040610c4d86828701610b4f565b9150509250925092565b600060ff82169050919050565b610c6d81610c57565b82525050565b6000602082019050610c886000830184610c64565b92915050565b600060208284031215610ca457610ca3610acb565b5b6000610cb284828501610b19565b91505092915050565b60008060408385031215610cd257610cd1610acb565b5b6000610ce085828601610b19565b9250506020610cf185828601610b19565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610d4257607f821691505b602082108103610d5557610d54610cfb565b5b50919050565b610d6481610af0565b82525050565b6000606082019050610d7f6000830186610d5b565b610d8c6020830185610bda565b610d996040830184610bda565b949350505050565b6000602082019050610db66000830184610d5b565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610df682610b2e565b9150610e0183610b2e565b9250828201905080821115610e1957610e18610dbc565b5b9291505056fea26469706673582212201ce3fc06792366bb245778c84a99112faf16f0d2b31c562700d94a4821b2c94364736f6c63430008140033").into())
        .value(U256::from(1000000e9))
        .input(bytes!("\
        0000000000000000000000000000000000000000000000000000000000000080\
        00000000000000000000000000000000000000000000000000000000000000c0\
        00000000000000000000000000000000000000000000d3c21bcecceda1000000\
        000000000000000000000000f39fd6e51aad88f6f4ce6ab8827279cfffb92266\
        000000000000000000000000000000000000000000000000000000000000000a\
        4d6f636b20546f6b656e00000000000000000000000000000000000000000000\
        0000000000000000000000000000000000000000000000000000000000000003\
        544b4e0000000000000000000000000000000000000000000000000000000000"));
    assert_eq!(signer_l1_wallet_owner, l1token_factory_tx_builder.tx.caller,);
    let result = l1token_factory_tx_builder.exec();
    match result {
        ExecutionResult::Success { output, .. } => match output {
            Output::Create(_, address) => {
                assert_eq!(l1token_contract_address, address.unwrap());
            }
            _ => panic!("expected 'create'"),
        },
        _ => panic!("expected 'success'"),
    }

    println!("\n\ncomputePeggedTokenAddress call:");

    // println!("address: {}", hex::encode(&l1token_contract_address));

    assert!(ctx
        .db
        .cache
        .accounts
        .contains_key(&erc20gateway_contract_address));
    let erc20gateway_contract_db_account = ctx
        .db
        .cache
        .accounts
        .get(&erc20gateway_contract_address)
        .unwrap();
    let erc20gateway_contract_db_account_info = erc20gateway_contract_db_account.info.clone();
    assert!(erc20gateway_contract_db_account_info.code.is_some());
    assert!(!erc20gateway_contract_db_account_info.code_hash.is_zero());
    let mut erc20gateway_factory_tx_builder = TxBuilder::call(
        &mut ctx,
        signer_l1_wallet_owner,
        erc20gateway_contract_address,
        None,
    )
    // data: 0x70616e69636b6564206174206372617465732f636f72652f7372632f636f6e7472616374732f65636c2e72733a34373a31373a2063616c6c206d6574686f64206661696c65642c206578697420636f64653a202d31303232
    .input(bytes!(
        "\
        aab858dd\
        000000000000000000000000dc64a140aa3e981100a9beca4e685f962f0cf6c9\
        "
    ));

    // 70616e69636b6564206174206372617465732f636f72652f7372632f636f6e74
    // 72616374732f65636c2e72733a34373a31373a2063616c6c206d6574686f6420
    // 6661696c65642c206578697420636f64653a202d31303232

    assert_eq!(
        signer_l1_wallet_owner,
        erc20gateway_factory_tx_builder.tx.caller,
    );
    let result = erc20gateway_factory_tx_builder.exec();
    assert!(!result.output().unwrap().is_empty());
    print_result_error(&result);
    assert!(result.is_success());
}

fn print_result_error(result: &ExecutionResult) {
    if result.is_success() {
        return;
    }
    let output = result.output().cloned().unwrap_or_default();
    println!("result: {:?}", result);
    println!("hex: 0x{}", hex::encode(output.as_ref()));
    let mut good_bytes = vec![];
    for b in output.iter() {
        if *b <= 0x7f {
            good_bytes.push(*b);
        }
    }
    if good_bytes.len() > 0 {
        println!("{}", from_utf8(&good_bytes).unwrap())
    } else if good_bytes.len() == 0 && output.len() > 0 {
        println!("[there is a result, but no utf-8 bytes]")
    }
}
